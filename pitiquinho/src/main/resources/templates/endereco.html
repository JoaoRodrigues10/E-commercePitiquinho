<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pitiquinho | Meus Endereços</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/endereco.css">
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container mt-5">
    <h2 class="mb-4">Seus endereços</h2>

    <!-- Botão adicionar endereço -->
    <div class="mb-4 text-end">
        <button class="btn-add-address" onclick="abrirModalNovoEndereco()">
            <i class="fas fa-plus"></i> Adicionar endereço
        </button>
    </div>

    <!-- Lista de endereços -->
    <div class="row row-cols-1 row-cols-md-2 g-4">
        <div class="col" th:each="endereco : ${enderecos}">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <div th:if="${endereco.padrao}">
                        <span class="badge bg-success mb-2">Endereço padrão</span>
                    </div>
                    <p class="card-text mb-1" th:text="${endereco.logradouro + ', ' + endereco.numero}">Rua X, 123</p>
                    <p class="card-text mb-1" th:text="${endereco.bairro}">Bairro</p>
                    <p class="card-text mb-1" th:text="${endereco.cidade + ', ' + endereco.uf + ' ' + endereco.cep}">Cidade, UF CEP</p>
                    <p class="card-text mb-1" th:text="${endereco.complemento}">Complemento</p>
                    <p class="card-text mb-2">Brasil</p>

                    <div class="d-flex gap-2">
                        <!-- Botão Alterar corrigido -->
                        <button type="button" class="btn btn-outline-secondary btn-sm"
                                th:attr="data-id=${endereco.id},
                                     data-cep=${endereco.cep},
                                     data-logradouro=${endereco.logradouro},
                                     data-numero=${endereco.numero},
                                     data-bairro=${endereco.bairro},
                                     data-cidade=${endereco.cidade},
                                     data-uf=${endereco.uf},
                                     data-complemento=${endereco.complemento},
                                     data-tipoEndereco=${endereco.tipoEndereco},
                                     data-padrao=${endereco.padrao}"
                                onclick="editarEndereco(this);">Alterar</button>

                        <a th:href="@{/endereco/excluir/{id}(id=${endereco.id})}" class="btn btn-outline-danger btn-sm"
                           onclick="return confirm('Deseja realmente excluir este endereço?')">Excluir</a>

                        <a th:if="${!endereco.padrao}"
                           th:href="@{/endereco/definir-padrao/{id}(id=${endereco.id})}"
                           class="btn btn-outline-primary btn-sm">Definir como padrão</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Único para Adicionar/Editar Endereço -->
<div class="modal fade" id="modalEndereco" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form th:action="@{/endereco/salvar}" th:object="${novoEndereco}" method="post" id="formEndereco">
                <input type="hidden" th:field="*{id}" />

                <!-- Primeiro endereço já como padrão -->
                <input type="hidden" th:if="${enderecos == null or enderecos.size() == 0}" th:field="*{padrao}" value="true"/>

                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitulo">Adicionar Endereço</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-1">
                        <label class="form-label">CEP</label>
                        <div class="input-group">
                            <input type="text" th:field="*{cep}" class="form-control" id="cep">
                            <button type="button" class="btn btn-outline-primary" id="buscarCep">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-1">
                        <label class="form-label">Logradouro</label>
                        <input type="text" th:field="*{logradouro}" class="form-control" id="logradouro"/>
                    </div>

                    <div class="mb-1">
                        <label class="form-label">Número</label>
                        <input type="text" th:field="*{numero}" class="form-control" id="numero"/>
                    </div>

                    <div class="mb-1">
                        <label class="form-label">Bairro</label>
                        <input type="text" th:field="*{bairro}" class="form-control" id="bairro"/>
                    </div>

                    <div class="mb-1">
                        <label class="form-label">Cidade</label>
                        <input type="text" th:field="*{cidade}" class="form-control" id="cidade"/>
                    </div>

                    <div class="mb-1">
                        <label class="form-label">UF</label>
                        <input type="text" th:field="*{uf}" class="form-control" id="uf"/>
                    </div>

                    <div class="mb-1">
                        <label class="form-label">Complemento</label>
                        <input type="text" th:field="*{complemento}" class="form-control" id="complemento"/>
                    </div>

                    <div class="mb-1">
                        <label class="form-label">Tipo de endereço</label>
                        <select th:field="*{tipoEndereco}" class="form-select" required>
                            <option th:value="RESIDENCIAL">Residencial</option>
                            <option th:value="COMERCIAL">Comercial</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn-add-address2">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function abrirModalNovoEndereco() {
        document.getElementById('modalTitulo').innerText = 'Adicionar Endereço';
        document.getElementById('formEndereco').reset();
        document.getElementById('formEndereco').elements['id'].value = '';
        var modal = new bootstrap.Modal(document.getElementById('modalEndereco'));
        modal.show();
    }

    function editarEndereco(button) {
        document.getElementById('modalTitulo').innerText = 'Editar Endereço';
        document.getElementById('formEndereco').elements['id'].value = button.dataset.id;
        document.getElementById('cep').value = button.dataset.cep || '';
        document.getElementById('logradouro').value = button.dataset.logradouro || '';
        document.getElementById('numero').value = button.dataset.numero || '';
        document.getElementById('bairro').value = button.dataset.bairro || '';
        document.getElementById('cidade').value = button.dataset.cidade || '';
        document.getElementById('uf').value = button.dataset.uf || '';
        document.getElementById('complemento').value = button.dataset.complemento || '';
        document.getElementById('formEndereco').elements['tipoEndereco'].value = button.dataset.tipoendereco || 'RESIDENCIAL';

        if(button.dataset.padrao === 'true'){
            var padraoCheckbox = document.getElementById('padraoEndereco');
            if(padraoCheckbox) padraoCheckbox.checked = true;
        }

        var modal = new bootstrap.Modal(document.getElementById('modalEndereco'));
        modal.show();
    }

    document.getElementById('buscarCep').addEventListener('click', function() {
        const cep = document.getElementById('cep').value.replace(/\D/g, '');
        if(cep.length !== 8){
            alert('CEP inválido!');
            return;
        }

        fetch(`https://viacep.com.br/ws/${cep}/json/`)
            .then(response => response.json())
            .then(data => {
                if(data.erro){
                    alert('CEP não encontrado!');
                    return;
                }
                document.getElementById('logradouro').value = data.logradouro || '';
                document.getElementById('bairro').value = data.bairro || '';
                document.getElementById('cidade').value = data.localidade || '';
                document.getElementById('uf').value = data.uf || '';
                const formatado = cep.replace(/^(\d{5})(\d{3})$/, "$1-$2");
                document.getElementById('cep').value = formatado;
            })
            .catch(err => alert('Erro ao buscar CEP!'));
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
